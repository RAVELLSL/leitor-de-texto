<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Texto</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Tema Claro (Padrão) */
            --cor-fundo: #f4f7f9;
            --cor-container: #ffffff;
            --cor-texto: #333;
            --cor-texto-suave: #777;
            --cor-borda: #ddd;
            --cor-input-fundo: #f9f9f9;
            --sombra: 0 10px 30px rgba(0, 82, 212, 0.1);
            --cor-primaria: #0052D4;
            --cor-secundaria: #65C7F7;
            --cor-pausa: #ffc107;
            --cor-neutra: #e9ecef;
            --cor-neutra-hover: #d8dde2;
        }

        body.dark-theme {
            /* Tema Escuro */
            --cor-fundo: #121212;
            --cor-container: #1e1e1e;
            --cor-texto: #e0e0e0;
            --cor-texto-suave: #999;
            --cor-borda: #444;
            --cor-input-fundo: #2c2c2c;
            --sombra: 0 10px 30px rgba(0, 0, 0, 0.2);
            --cor-neutra: #333;
            --cor-neutra-hover: #444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            position: relative;
            background-color: var(--cor-container);
            width: 100%;
            max-width: 700px;
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: var(--sombra);
            border: 1px solid var(--cor-borda);
            transition: all 0.3s ease;
        }

        .container.is-speaking {
            box-shadow: 0 0 0 4px var(--cor-primaria), 0 0 0 8px var(--cor-secundaria), var(--sombra);
        }
        .container.is-paused {
            box-shadow: 0 0 0 4px var(--cor-pausa), var(--sombra);
        }

        header { text-align: center; margin-bottom: 25px; }
        header h1 { color: var(--cor-primaria); font-weight: 600; }
        header p { font-size: 0.9em; color: var(--cor-texto-suave); }

        .textarea-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .textarea-header label { font-weight: 600; font-size: 0.9em; }
        .textarea-header .actions { display: flex; align-items: center; gap: 5px; }
        #botaoColar, #botaoLimpar { background: none; border: none; cursor: pointer; color: var(--cor-primaria); padding: 5px; border-radius: 5px; display: flex; align-items: center; justify-content: center; }
        #botaoColar:hover, #botaoLimpar:hover { background-color: var(--cor-neutra); }

        main textarea {
            width: 100%; height: 160px; padding: 15px; font-size: 1em; border: 1px solid var(--cor-borda);
            border-radius: 10px; resize: vertical; font-family: 'Poppins', sans-serif;
            background-color: var(--cor-input-fundo); color: var(--cor-texto); transition: background-color 0.3s ease, color 0.3s ease;
        }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; margin-bottom: 25px; }
        .control-group { display: flex; flex-direction: column; }
        .control-group label { margin-bottom: 8px; font-weight: 600; font-size: 0.9em; color: var(--cor-texto-suave); }
        .control-group select { width: 100%; padding: 12px; border: 1px solid var(--cor-borda); border-radius: 8px; background-color: var(--cor-input-fundo); color: var(--cor-texto); font-size: 0.9em; cursor: pointer; }
        
        .slider-wrapper { display: flex; align-items: center; gap: 10px; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--cor-neutra); border-radius: 5px; outline: none; cursor: pointer; transition: background 0.2s ease; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--cor-primaria); border-radius: 50%; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--cor-primaria); border-radius: 50%; cursor: pointer; }
        
        .slider-wrapper span { font-weight: 600; min-width: 35px; text-align: center; background-color: var(--cor-neutra); padding: 5px; border-radius: 5px; font-size: 0.8em; color: var(--cor-texto); }
        
        .progress-section { display: none; align-items: center; gap: 15px; margin-bottom: 25px; }
        .timeline-wrapper { flex-grow: 1; height: 10px; background-color: var(--cor-neutra); border-radius: 5px; overflow: hidden; }
        .timeline-progress { width: 0%; height: 100%; background-color: var(--cor-primaria); border-radius: 5px; transition: width 0.1s linear; }
        #timelinePercentage { font-weight: 600; color: var(--cor-texto-suave); min-width: 40px; text-align: right; }
        
        footer { display: flex; gap: 15px; flex-wrap: wrap; }
        footer button { flex-grow: 1; padding: 15px 10px; font-size: 1em; font-weight: 600; border-radius: 10px; cursor: pointer; border: none; transition: all 0.2s ease; display: flex; justify-content: center; align-items: center; gap: 8px; }

        #botaoFalar { background-color: var(--cor-primaria); color: #fff; }
        #botaoFalar:hover { background-color: #0041a8; }
        #botaoFalar.paused { background-color: var(--cor-pausa); color: var(--cor-texto); }
        #botaoFalar.paused:hover { background-color: #e0ac00; }

        #botaoParar, #botaoReset { background-color: var(--cor-neutra); color: var(--cor-texto); }
        #botaoParar:hover, #botaoReset:hover { background-color: var(--cor-neutra-hover); }

        .theme-switch-wrapper { position: absolute; top: 20px; right: 20px; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        .slider:before { background-color: white; bottom: 3px; content: ""; height: 18px; left: 4px; position: absolute; transition: .4s; width: 18px; border-radius: 50%; }
        input:checked + .slider { background-color: var(--cor-primaria); }
        input:checked + .slider:before { transform: translateX(26px); }

        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            .controls { grid-template-columns: 1fr; }
            header h1 { font-size: 1.5em; }
        }
    </style>
</head>
<body>
    <div class="container" id="containerPrincipal">
        <div class="theme-switch-wrapper">
            <label class="theme-switch">
                <input type="checkbox" id="themeToggle">
                <span class="slider"></span>
            </label>
        </div>
        <header>
            <h1>Leitor de Texto</h1>
        </header>
        <main>
            <div class="textarea-header">
                <label for="textoParaFalar">Seu Texto</label>
                <div class="actions">
                    <button id="botaoColar" title="Colar da área de transferência">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <title>Colar Texto</title>
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                    </button>
                    <button id="botaoLimpar" title="Limpar Texto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <title>Limpar Texto</title>
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <textarea id="textoParaFalar" placeholder="Digite ou cole textos de qualquer tamanho aqui..."></textarea>
            <div class="controls">
                <div class="control-group">
                    <label for="seletorVoz">Voz</label>
                    <select id="seletorVoz"><option>Carregando vozes...</option></select>
                </div>
                <div class="control-group">
                    <label for="volume">Volume</label>
                    <div class="slider-wrapper">
                        <input type="range" id="volume" min="0" max="1" value="1" step="0.1">
                        <span id="volumeValor">1.0</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="velocidade">Velocidade</label>
                    <div class="slider-wrapper">
                        <input type="range" id="velocidade" min="0.5" max="3" value="1" step="0.1">
                        <span id="velocidadeValor">1.0</span>
                    </div>
                </div>
                <div class="control-group">
                    <label for="tom">Tom</label>
                    <div class="slider-wrapper">
                        <input type="range" id="tom" min="0" max="2" value="1" step="0.1">
                        <span id="tomValor">1.0</span>
                    </div>
                </div>
            </div>
        </main>
        <div class="progress-section" id="progressSection">
            <div class="timeline-wrapper">
                <div class="timeline-progress" id="timelineProgress"></div>
            </div>
            <span id="timelinePercentage">0%</span>
        </div>
        <footer>
            <button id="botaoFalar" title="Falar">
                </button>
            <button id="botaoParar" title="Parar">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <title>Parar</title>
                    <rect x="6" y="6" width="12" height="12"></rect>
                </svg>
                Parar
            </button>
            <button id="botaoReset" title="Resetar Configurações">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <title>Resetar Configurações</title>
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Resetar
            </button>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        if (!('speechSynthesis' in window)) {
            alert('Desculpe, seu navegador não suporta a síntese de fala.');
            document.body.innerHTML = '<h1>Navegador incompatível</h1>';
            return;
        }

        // --- DOM Elements ---
        const synth = window.speechSynthesis;
        const qs = (selector) => document.querySelector(selector);
        const container = qs('#containerPrincipal');
        const textoInput = qs('#textoParaFalar');
        const seletorVoz = qs('#seletorVoz');
        const botaoFalar = qs('#botaoFalar');
        const botaoParar = qs('#botaoParar');
        const botaoReset = qs('#botaoReset');
        const botaoColar = qs('#botaoColar');
        const botaoLimpar = qs('#botaoLimpar');
        const velocidadeInput = qs('#velocidade');
        const velocidadeValor = qs('#velocidadeValor');
        const tomInput = qs('#tom');
        const tomValor = qs('#tomValor');
        const volumeInput = qs('#volume');
        const volumeValor = qs('#volumeValor');
        const themeToggle = qs('#themeToggle');
        const progressSection = qs('#progressSection');
        const timelineProgress = qs('#timelineProgress');
        const timelinePercentage = qs('#timelinePercentage');

        // --- State ---
        let vozes = [];
        let speechQueue = [];
        let currentUtteranceIndex = 0;
        let charOffset = 0;
        const DEFAULT_SETTINGS = { volume: 1, velocidade: 1, tom: 1 };

        // --- Core Functions ---
        const carregarVozes = () => {
            vozes = synth.getVoices();
            const vozesPt = vozes.filter(voz => voz.lang.startsWith('pt'));
            seletorVoz.innerHTML = '';

            if (vozesPt.length === 0) {
                seletorVoz.innerHTML = '<option value="">Nenhuma voz em PT encontrada</option>';
                return;
            }

            vozesPt.forEach(voz => {
                const option = document.createElement('option');
                option.textContent = `${voz.name} (${voz.lang})`;
                option.setAttribute('data-name', voz.name);
                seletorVoz.appendChild(option);
            });
        };
        
        const chunkifyText = (text, maxLength = 200) => {
            const sentences = text.match(/[^.!?]+[.!?]*|[^.!?\s]+/g) || [];
            let chunks = [];
            let currentChunk = "";
            sentences.forEach(sentence => {
                if (currentChunk.length + sentence.length <= maxLength) {
                    currentChunk += sentence + " ";
                } else {
                    if (currentChunk.length > 0) chunks.push(currentChunk.trim());
                    currentChunk = sentence + " ";
                }
            });
            if (currentChunk.length > 0) chunks.push(currentChunk.trim());
            return chunks;
        };

        const speakNextChunk = () => {
            // CORREÇÃO APLICADA AQUI: Removida a verificação '|| !synth.speaking'
            if (currentUtteranceIndex >= speechQueue.length) {
                // Se a fila terminou, mas a API ainda está 'speaking',
                // pode ser um delay. Chamamos finalizarFala() para garantir o reset da UI.
                if(!synth.speaking) {
                   finalizarFala();
                }
                return;
            }

            const chunk = speechQueue[currentUtteranceIndex];
            const utterance = new SpeechSynthesisUtterance(chunk);
            const nomeVozSelecionada = seletorVoz.selectedOptions[0]?.getAttribute('data-name');
            
            utterance.voice = vozes.find(voz => voz.name === nomeVozSelecionada);
            utterance.volume = parseFloat(volumeInput.value);
            utterance.rate = parseFloat(velocidadeInput.value);
            utterance.pitch = parseFloat(tomInput.value);

            utterance.onboundary = (event) => {
                if (textoInput.value.length > 0) {
                    const totalChars = textoInput.value.length;
                    const progress = Math.min(((charOffset + event.charIndex) / totalChars) * 100, 100);
                    timelineProgress.style.width = `${progress}%`;
                    timelinePercentage.textContent = `${Math.round(progress)}%`;
                }
            };

            utterance.onend = () => {
                charOffset += chunk.length + 1; // +1 para o espaço
                currentUtteranceIndex++;
                speakNextChunk(); // Chama o próximo da fila
            };

            synth.speak(utterance);
        };

        // --- UI Updates & State Management ---
        const atualizarBotaoFalar = () => {
            if (synth.paused) {
                botaoFalar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Continuar</title><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> Continuar`;
                botaoFalar.classList.add('paused');
                container.classList.add('is-paused');
                container.classList.remove('is-speaking');
            } else if (synth.speaking) {
                botaoFalar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Pausar</title><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg> Pausar`;
                botaoFalar.classList.remove('paused');
                container.classList.remove('is-paused');
                container.classList.add('is-speaking');
            } else {
                botaoFalar.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Falar</title><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg> Falar`;
                botaoFalar.classList.remove('paused');
                container.classList.remove('is-speaking', 'is-paused');
            }
        };

        const iniciarNovaFala = () => {
            if (textoInput.value.trim() === '' || vozes.length === 0) return;
            
            // Garante que o estado anterior seja limpo antes de começar
            if (synth.speaking) {
                synth.cancel();
            }
            
            setTimeout(() => {
                speechQueue = chunkifyText(textoInput.value);
                currentUtteranceIndex = 0;
                charOffset = 0;
                
                progressSection.style.display = 'flex';
                timelineProgress.style.width = '0%';
                timelinePercentage.textContent = '0%';
                
                speakNextChunk();
                atualizarBotaoFalar();
            }, 100); // Pequeno delay para garantir que o 'cancel' seja processado
        };

        const finalizarFala = () => {
            setTimeout(() => {
                timelineProgress.style.width = '100%';
                timelinePercentage.textContent = '100%';
                setTimeout(() => { 
                    progressSection.style.display = 'none';
                    atualizarBotaoFalar();
                }, 500);
            }, 100);
        };

        const parar = () => {
            synth.cancel();
            speechQueue = [];
            currentUtteranceIndex = 0;
            progressSection.style.display = 'none';
            atualizarBotaoFalar();
        };

        const resetarConfiguracoes = () => {
            parar();
            velocidadeInput.value = DEFAULT_SETTINGS.velocidade;
            velocidadeValor.textContent = DEFAULT_SETTINGS.velocidade.toFixed(1);
            tomInput.value = DEFAULT_SETTINGS.tom;
            tomValor.textContent = DEFAULT_SETTINGS.tom.toFixed(1);
            volumeInput.value = DEFAULT_SETTINGS.volume;
            volumeValor.textContent = DEFAULT_SETTINGS.volume.toFixed(1);
            if (seletorVoz.options.length > 0) seletorVoz.selectedIndex = 0;
        };

        const mudarTema = (isDark) => {
            document.body.classList.toggle('dark-theme', isDark);
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };
        
        // --- Event Listeners ---
        botaoFalar.addEventListener('click', () => {
            if (synth.paused) {
                synth.resume();
            } else if (synth.speaking) {
                synth.pause();
            } else {
                iniciarNovaFala();
            }
        });
        
        synth.onpause = atualizarBotaoFalar;
        synth.onresume = atualizarBotaoFalar;
        
        botaoParar.addEventListener('click', parar);
        botaoReset.addEventListener('click', resetarConfiguracoes);
        
        botaoColar.addEventListener('click', async () => {
            if (!navigator.clipboard) {
                alert('Seu navegador não suporta a API de Área de Transferência.');
                return;
            }
            try {
                const text = await navigator.clipboard.readText();
                textoInput.value = text;
            } catch (err) {
                console.error('Falha ao colar:', err);
                alert('Falha ao colar o texto. A permissão pode ter sido negada.');
            }
        });
        
        botaoLimpar.addEventListener('click', () => {
            textoInput.value = '';
            parar();
        });

        velocidadeInput.addEventListener('input', (e) => velocidadeValor.textContent = parseFloat(e.target.value).toFixed(1));
        tomInput.addEventListener('input', (e) => tomValor.textContent = parseFloat(e.target.value).toFixed(1));
        volumeInput.addEventListener('input', (e) => volumeValor.textContent = parseFloat(e.target.value).toFixed(1));
        themeToggle.addEventListener('change', (e) => mudarTema(e.target.checked));

        // --- Initialization ---
        const init = () => {
            carregarVozes();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = carregarVozes;
            }
            
            atualizarBotaoFalar();

            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                themeToggle.checked = true;
                mudarTema(true);
            }
        };

        init();
    });
    </script>
</body>
</html>
